<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="permissions-policy" content="accelerometer=*, autoplay=*, camera=*, clipboard-write=*, encrypted-media=*, fullscreen=*, geolocation=*, gyroscope=*, magnetometer=*, microphone=*, midi=*, payment=*, picture-in-picture=*, publickey-credentials-get=*, screen-wake-lock=*, sync-xhr=*, usb=*, web-share=*, xr-spatial-tracking=*">
  <title>Drive on Mars</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }
    .controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 5px;
    }
    .youtube-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .youtube-button:hover {
      background-color: rgba(0, 0, 0, 0.7);
    }
    #youtube-audio-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      z-index: 1000;
      display: none;
      border: 1px solid rgba(255, 107, 53, 0.3);
      backdrop-filter: blur(10px);
      font-size: 12px;
    }
    #youtube-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #youtube-controls button {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #youtube-controls button:hover {
      background: rgba(255, 107, 53, 0.5);
    }
    #youtube-controls input {
      width: 60px;
      height: 16px;
    }
    #youtube-title {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 11px;
      opacity: 0.8;
    }
    
    /* Preloader Styles */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
    }
    
    #preloader h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    
    #loading-progress {
      width: 400px;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    #loading-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      border-radius: 8px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    #loading-text {
      font-size: 1.2rem;
      margin-top: 10px;
      opacity: 0.8;
    }
    
    #loading-tips {
      position: absolute;
      bottom: 50px;
      text-align: center;
      opacity: 0.6;
      font-size: 0.9rem;
    }
    
    /* Performance Settings */
    #performance-settings {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      min-width: 250px;
    }
    
    #performance-settings h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #ff6b35;
    }
    
    #performance-settings select,
    #performance-settings input {
      width: 100%;
      padding: 5px;
      margin: 5px 0;
      border: 1px solid #555;
      background: #333;
      color: white;
      border-radius: 4px;
    }
    
    #performance-settings button {
      background: #ff6b35;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    #performance-settings button:hover {
      background: #e55a2b;
    }
    
    .settings-toggle {
      position: absolute;
      top: 70px;
      left: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .settings-toggle:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    
    /* Device indicator */
    #device-info {
      position: absolute;
      top: 120px;
      left: 20px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      display: none;
    }
    
    /* Mobile Controls */
    #mobile-controls {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: 0;
      z-index: 1000;
      pointer-events: none;
    }
    
    #mobile-controls.show {
      display: block;
    }
    
    /* Virtual Joystick */
    #virtual-joystick {
      position: absolute;
      bottom: 40px;
      left: 40px;
      width: 140px;
      height: 140px;
      background: rgba(0, 0, 0, 0.4);
      border: 3px solid rgba(255, 107, 53, 0.5);
      border-radius: 50%;
      pointer-events: auto;
      touch-action: none;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    #joystick-knob {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      background: linear-gradient(145deg, #ff6b35, #e55a2b);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.1s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Mobile Action Buttons */
    #mobile-buttons {
      position: absolute;
      bottom: 40px;
      right: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      pointer-events: auto;
      max-width: 180px;
    }
    
    .mobile-btn {
      width: 75px;
      height: 75px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: 3px solid rgba(255, 107, 53, 0.5);
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .mobile-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 107, 53, 0.05));
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }
    
    .mobile-btn:hover::before {
      opacity: 1;
    }
    
    .mobile-btn .btn-label {
      font-size: 8px;
      font-weight: bold;
      letter-spacing: 0.5px;
      margin-top: 2px;
      opacity: 0.8;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      transition: opacity 0.15s ease;
    }
    
    .mobile-btn:active {
      background: rgba(255, 107, 53, 0.9);
      transform: scale(0.85);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 107, 53, 1);
    }
    
    .mobile-btn:active .btn-label {
      opacity: 1;
    }
    
    .mobile-btn:hover {
      background: rgba(255, 107, 53, 0.7);
      border-color: rgba(255, 107, 53, 0.8);
      transform: scale(1.05);
    }
    
    /* Add a subtle pulsing animation for better visibility */
    .mobile-btn {
      animation: mobileBtnPulse 3s ease-in-out infinite;
    }
    
    @keyframes mobileBtnPulse {
      0%, 100% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      50% {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 107, 53, 0.2);
      }
    }
    
    /* Touch Camera Controls */
    #touch-camera-area {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 200px;
      pointer-events: auto;
      touch-action: none;
    }
    
    /* Desktop optimizations */
    @media (min-width: 769px) {
      /* Hide mobile-specific elements on desktop */
      #mobile-controls {
        display: none !important;
      }
      
      /* Better desktop positioning */
      #youtube-audio-container {
        bottom: 30px;
        right: 30px;
        padding: 12px 16px;
        font-size: 13px;
      }
      
      #youtube-controls {
        gap: 12px;
      }
      
      #youtube-controls button {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      #youtube-controls input {
        width: 80px;
        height: 18px;
      }
      
      #youtube-title {
        max-width: 150px;
        font-size: 12px;
      }
      
      .settings-toggle {
        padding: 12px 18px;
        font-size: 15px;
      }
      
      .controls {
        padding: 12px 16px;
        font-size: 14px;
      }
    }
    
    /* Mobile HUD adjustments */
    @media (max-width: 768px) {
      #preloader h1 { font-size: 2rem; }
      #loading-progress { width: 300px; }
      #performance-settings { 
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        width: auto;
        min-width: auto;
      }
      
      /* Mobile HUD positioning to avoid navigation interference */
      #hud {
        top: 10px !important;
        right: 10px !important;
        left: auto !important;
        max-width: 160px !important;
        font-size: 10px !important;
        padding: 8px !important;
        z-index: 150 !important;
      }
      
      /* Mobile controls positioning - removed since controls panel is disabled on mobile */
      
      /* Ensure mobile navigation doesn't interfere with HUD */
      #virtual-joystick {
        bottom: 30px !important;
        left: 30px !important;
        z-index: 120 !important;
      }
      
      #mobile-buttons {
        bottom: 30px !important;
        right: 20px !important;
        z-index: 120 !important;
      }
      
      /* Add space between mobile controls and HUD panels */
      #mobile-controls {
        z-index: 120 !important;
      }
      
      .controls {
        bottom: 240px !important;
        font-size: 12px;
        padding: 8px;
        left: 10px;
        right: 10px;
        width: auto;
        text-align: center;
      }
      
      #youtube-audio-container {
        bottom: 200px;
        right: 10px;
        font-size: 10px;
        padding: 6px 10px;
      }
      
      #youtube-controls {
        gap: 6px;
        flex-wrap: wrap;
      }
      
      #youtube-controls button {
        padding: 4px 8px;
        font-size: 10px;
      }
      
      #youtube-controls input {
        width: 40px;
        height: 12px;
      }
      
      #youtube-title {
        max-width: 80px;
        font-size: 9px;
      }
      
      /* Larger mobile buttons for better touch */
      .mobile-btn {
        width: 75px;
        height: 75px;
        font-size: 24px;
      }
      
      #mobile-buttons {
        gap: 12px;
        max-width: 170px;
      }
      
      #virtual-joystick {
        width: 150px;
        height: 150px;
        bottom: 30px;
        left: 30px;
      }
      
      #joystick-knob {
        width: 55px;
        height: 55px;
      }
    }
    
    /* Joystick touch feedback */
    #virtual-joystick::before {
      content: '';
      position: absolute;
      top: -8px;
      left: -8px;
      right: -8px;
      bottom: -8px;
      border: 2px solid rgba(255, 107, 53, 0.2);
      border-radius: 50%;
      animation: joystickPulse 3s infinite;
    }
    
    #virtual-joystick::after {
      content: 'MOVE';
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    @keyframes joystickPulse {
      0%, 100% { 
        opacity: 0.3; 
        transform: scale(1); 
        border-color: rgba(255, 107, 53, 0.2);
      }
      50% { 
        opacity: 0.8; 
        transform: scale(1.05); 
        border-color: rgba(255, 107, 53, 0.5);
      }
    }
    
    /* Hide bottom mode buttons (day/night, stylized mode) */
    .hidden-mode-button {
      display: none !important;
    }
    
    /* Target specific bottom positioned buttons */
    button[style*="bottom: 20px"][style*="right: 20px"],
    button[style*="bottom: 20px"][style*="right: 180px"],
    button[style*="bottom: 60px"][style*="right: 20px"] {
      display: none !important;
    }
  </style>
  <!-- Load Three.js libraries as regular scripts -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader">
    <h1>Drive on Mars</h1>
    <div id="loading-progress">
      <div id="loading-bar"></div>
    </div>
    <div id="loading-text">Loading Mars Environment...</div>
    <div id="loading-tips">
      <span id="loading-tip-text">💡 Tip: Use WASD keys to drive the rover and mouse to look around</span>
    </div>
  </div>

  <!-- Performance Settings -->
  <div id="performance-settings">
    <h3>Performance Settings</h3>
    <label>Graphics Quality:</label>
    <select id="graphics-quality">
      <option value="low">Low (Mobile/Weak PC)</option>
      <option value="medium">Medium (Most PCs)</option>
      <option value="high">High (Powerful PC)</option>
      <option value="auto">Auto Detect</option>
    </select>
    
    <label>Texture Quality:</label>
    <select id="texture-quality">
      <option value="low">Low (512px)</option>
      <option value="medium">Medium (1024px)</option>
      <option value="high">High (2048px)</option>
      <option value="ultra">Ultra (4096px)</option>
    </select>
    
    <label>Particle Count:</label>
    <select id="particle-count">
      <option value="low">Low (100)</option>
      <option value="medium">Medium (500)</option>
      <option value="high">High (1000)</option>
    </select>
    
    <label>Render Distance:</label>
    <select id="render-distance">
      <option value="low">Low (3000m)</option>
      <option value="medium">Medium (5000m)</option>
      <option value="high">High (7000m)</option>
    </select>
    
    <button id="apply-settings">Apply Settings</button>
  </div>

  <button class="settings-toggle" id="settings-toggle">⚙️ Settings</button>
  
  <div id="device-info">
    <div id="device-specs"></div>
  </div>

  <!-- Mobile Controls -->
  <div id="mobile-controls">
    <!-- Touch Camera Area -->
    <div id="touch-camera-area"></div>
    
    <!-- Virtual Joystick -->
    <div id="virtual-joystick">
      <div id="joystick-knob"></div>
    </div>
    
    <!-- Mobile Action Buttons -->
    <div id="mobile-buttons">
      <button class="mobile-btn" id="mobile-sample-btn" title="Collect Sample">
        💎
        <span class="btn-label">SAMPLE</span>
      </button>
      <button class="mobile-btn" id="mobile-analyze-btn" title="Analyze Sample">
        🔬
        <span class="btn-label">ANALYZE</span>
      </button>
      <button class="mobile-btn" id="mobile-rocket-btn" title="Launch Rocket">
        🚀
        <span class="btn-label">ROCKET</span>
      </button>
      <button class="mobile-btn" id="mobile-camera-btn" title="Switch Camera">
        📷
        <span class="btn-label">CAMERA</span>
      </button>
    </div>
  </div>

  <div class="controls">
   
  </div>
  <button id="load-youtube" class="youtube-button">Load YouTube Audio</button>
  
  <!-- YouTube Audio Container -->
  <div id="youtube-audio-container">
    <div id="youtube-player-wrapper"></div>
    <div id="youtube-controls">
      <button id="youtube-play-pause">Play</button>
      <div>
        <label for="youtube-volume">Volume:</label>
        <input type="range" id="youtube-volume" min="0" max="100" value="30" style="width: 100px;">
      </div>
      <div id="youtube-title">YouTube Audio</div>
    </div>
  </div>
  
  <script>
    // Enhanced mobile detection with improved heuristics - global function
    function isMobileDevice() {
      const userAgent = navigator.userAgent.toLowerCase();
      
      // Traditional UA detection
      const uaCheck = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
      
      // Enhanced detection for newer iPads and tablets that report as desktop
      const touchCheck = navigator.maxTouchPoints > 0 && window.innerWidth < 1024;
      
      // Additional mobile indicators
      const orientationCheck = 'orientation' in window;
      const smallScreenCheck = window.innerWidth <= 768;
      
      return uaCheck || touchCheck || (orientationCheck && smallScreenCheck);
    }

    // Performance optimization and preloader system
    class GameOptimizer {
      constructor() {
        this.deviceSpecs = this.detectDeviceSpecs();
        this.performanceSettings = this.getOptimalSettings();
        this.loadingProgress = 0;
        this.loadingSteps = [
          'Detecting device capabilities...',
          'Loading 3D engine...',
          'Generating Mars terrain...',
          'Creating rover model...',
          'Generating space environment...',
          'Initializing physics...',
          'Preparing ambient audio...',
          this.deviceSpecs.isMobile ? 'Setting up touch controls...' : 'Final optimization...'
        ];
        this.currentStep = 0;
        
        this.initializePreloader();
        this.initializePerformanceSettings();
        this.startOptimizedLoading();
      }
      
      detectDeviceSpecs() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        // Safe GPU renderer detection with proper fallback
        let gpuRenderer = 'Unknown';
        if (gl) {
          try {
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (debugInfo) {
              gpuRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'Unknown';
            }
          } catch (error) {
            console.warn('Could not detect GPU renderer:', error);
          }
        }
        
        const specs = {
          isMobile: isMobileDevice(),
          deviceMemory: navigator.deviceMemory || 4,
          hardwareConcurrency: navigator.hardwareConcurrency || 4,
          maxTextureSize: gl ? gl.getParameter(gl.MAX_TEXTURE_SIZE) : 2048,
          renderer: gpuRenderer,
          maxViewportDims: gl ? gl.getParameter(gl.MAX_VIEWPORT_DIMS) : [1920, 1080],
          pixelRatio: window.devicePixelRatio || 1,
          screenSize: Math.max(window.screen.width, window.screen.height),
          connectionType: navigator.connection?.effectiveType || 'unknown'
        };
        
        // Calculate performance score
        let performanceScore = 0;
        if (!specs.isMobile) performanceScore += 30;
        if (specs.deviceMemory >= 8) performanceScore += 25;
        if (specs.hardwareConcurrency >= 4) performanceScore += 20;
        if (specs.maxTextureSize >= 4096) performanceScore += 15;
        if (specs.screenSize >= 1920) performanceScore += 10;
        
        specs.performanceScore = performanceScore;
        specs.performanceLevel = this.getPerformanceLevel(performanceScore);
        
        return specs;
      }
      
      getPerformanceLevel(score) {
        if (score >= 70) return 'high';
        if (score >= 40) return 'medium';
        return 'low';
      }
      
      getOptimalSettings() {
        const level = this.deviceSpecs.performanceLevel;
        const isMobile = this.deviceSpecs.isMobile;
        
        const settings = {
          low: {
            textureSize: 512,
            particleCount: 100,
            renderDistance: 3000,
            shadowQuality: 'none',
            antialiasing: false,
            skyboxResolution: 1024,
            detailLevel: 'basic',
            fogDistance: 2000
          },
          medium: {
            textureSize: 1024,
            particleCount: 500,
            renderDistance: 5000,
            shadowQuality: 'low',
            antialiasing: true,
            skyboxResolution: 2048,
            detailLevel: 'normal',
            fogDistance: 4000
          },
          high: {
            textureSize: 2048,
            particleCount: 1000,
            renderDistance: 7000,
            shadowQuality: 'high',
            antialiasing: true,
            skyboxResolution: 4096,
            detailLevel: 'high',
            fogDistance: 6000
          }
        };
        
        return settings[level];
      }
      
      initializePreloader() {
        const preloader = document.getElementById('preloader');
        const loadingBar = document.getElementById('loading-bar');
        const loadingText = document.getElementById('loading-text');
        
        // Update tip text for mobile devices
        const tipText = document.getElementById('loading-tip-text');
        if (tipText && this.deviceSpecs.isMobile) {
          tipText.textContent = '🎮 Tip: Use virtual joystick to move and swipe to look around';
        }
        
        // Show device info with enhanced mobile detection
        const deviceInfo = document.getElementById('device-info');
        const deviceSpecs = document.getElementById('device-specs');
        
        // Get mobile tier if applicable
        let mobileTierInfo = '';
        if (this.deviceSpecs.isMobile) {
          // Simulate mobile tier detection (matching the logic in mars.js)
          const deviceMemory = navigator.deviceMemory || 4;
          const hardwareConcurrency = navigator.hardwareConcurrency || 4;
          const screenSize = Math.max(window.screen.width, window.screen.height);
          const pixelRatio = window.devicePixelRatio || 1;
          
          let mobileScore = 0;
          if (deviceMemory >= 8) mobileScore += 30;
          else if (deviceMemory >= 6) mobileScore += 20;
          else if (deviceMemory >= 4) mobileScore += 10;
          
          if (hardwareConcurrency >= 8) mobileScore += 25;
          else if (hardwareConcurrency >= 6) mobileScore += 15;
          else if (hardwareConcurrency >= 4) mobileScore += 10;
          
          if (screenSize >= 1920) mobileScore += 20;
          else if (screenSize >= 1440) mobileScore += 15;
          else if (screenSize >= 1080) mobileScore += 10;
          
          if (pixelRatio >= 3) mobileScore += 10;
          else if (pixelRatio >= 2) mobileScore += 5;
          
          const mobileTier = mobileScore >= 60 ? 'high' : mobileScore >= 30 ? 'medium' : 'low';
          const tierEmoji = mobileTier === 'high' ? '🔥' : mobileTier === 'medium' ? '⚡' : '📱';
          const tierName = mobileTier === 'high' ? 'High-End' : mobileTier === 'medium' ? 'Mid-Range' : 'Budget';
          
          mobileTierInfo = `<br>Mobile Tier: ${tierEmoji} ${tierName} (Score: ${mobileScore})`;
        }
        
        // Check for Samsung device for display optimization info
        let deviceBrandInfo = '';
        if (this.deviceSpecs.isMobile) {
          const userAgent = navigator.userAgent.toLowerCase();
          const isSamsung = /samsung|sm-|galaxy/i.test(userAgent);
          const isPixel = /pixel/i.test(userAgent);
          
          if (isSamsung) {
            deviceBrandInfo = '<br><span style="color: #1ba1e2;">📱 Samsung - Display optimizations applied</span>';
          } else if (isPixel) {
            deviceBrandInfo = '<br><span style="color: #34a853;">📱 Pixel - Standard rendering</span>';
          }
        }
        
        deviceSpecs.innerHTML = `
          Device: ${this.deviceSpecs.isMobile ? 'Mobile' : 'Desktop'}<br>
          Performance: ${this.deviceSpecs.performanceLevel.toUpperCase()}<br>
          Memory: ${this.deviceSpecs.deviceMemory}GB<br>
          CPU Cores: ${this.deviceSpecs.hardwareConcurrency}
          ${mobileTierInfo}
          ${deviceBrandInfo}
          ${this.deviceSpecs.isMobile ? '<br><span style="color: #ff6b35;">🎮 Touch controls enabled</span>' : ''}
        `;
        
        // Auto-hide device info after 3 seconds
        setTimeout(() => {
          deviceInfo.style.display = 'none';
        }, 3000);
      }
      
      initializePerformanceSettings() {
        const settingsToggle = document.getElementById('settings-toggle');
        const performanceSettings = document.getElementById('performance-settings');
        const applySettings = document.getElementById('apply-settings');
        
        // Set default values based on device
        document.getElementById('graphics-quality').value = this.deviceSpecs.performanceLevel;
        document.getElementById('texture-quality').value = this.deviceSpecs.performanceLevel;
        document.getElementById('particle-count').value = this.deviceSpecs.performanceLevel;
        document.getElementById('render-distance').value = this.deviceSpecs.performanceLevel;
        
        settingsToggle.addEventListener('click', () => {
          performanceSettings.style.display = performanceSettings.style.display === 'none' ? 'block' : 'none';
        });
        
        applySettings.addEventListener('click', () => {
          this.applyPerformanceSettings();
          performanceSettings.style.display = 'none';
        });
      }
      
      applyPerformanceSettings() {
        const graphicsQuality = document.getElementById('graphics-quality').value;
        const textureQuality = document.getElementById('texture-quality').value;
        const particleCount = document.getElementById('particle-count').value;
        const renderDistance = document.getElementById('render-distance').value;
        
        // Update global performance settings
        window.GAME_PERFORMANCE_SETTINGS = {
          graphicsQuality,
          textureQuality,
          particleCount,
          renderDistance,
          ...this.performanceSettings
        };
        
        console.log('Performance settings applied:', window.GAME_PERFORMANCE_SETTINGS);
        
        // Show restart notification
        this.showRestartNotification();
      }
      
      showRestartNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(255, 107, 53, 0.9);
          color: white;
          padding: 15px;
          border-radius: 8px;
          z-index: 10001;
          font-size: 14px;
          max-width: 300px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        notification.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">Settings Applied</div>
          <div>Some changes may require a page refresh for full effect.</div>
          <button onclick="location.reload()" style="
            background: white;
            color: #ff6b35;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
          ">Refresh Page</button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }
      
      async startOptimizedLoading() {
        const loadingBar = document.getElementById('loading-bar');
        const loadingText = document.getElementById('loading-text');
        
        // Check WebGL support first
        if (!this.checkWebGLSupport()) {
          return;
        }
        
        // Set initial global settings
        window.GAME_PERFORMANCE_SETTINGS = {
          ...this.performanceSettings,
          graphicsQuality: this.deviceSpecs.performanceLevel,
          textureQuality: this.deviceSpecs.performanceLevel,
          particleCount: this.deviceSpecs.performanceLevel,
          renderDistance: this.deviceSpecs.performanceLevel
        };
        
        // Simulate loading steps with actual progress
        for (let i = 0; i < this.loadingSteps.length; i++) {
          loadingText.textContent = this.loadingSteps[i];
          
          // Simulate processing time
          await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 400));
          
          this.loadingProgress = ((i + 1) / this.loadingSteps.length) * 100;
          loadingBar.style.width = this.loadingProgress + '%';
        }
        
        // Load the main game script
        try {
          await this.loadGameScript();
          
          // Load and start ambient music after game loads
          this.loadAmbientMusic();
          
          // Hide preloader with fade out
          setTimeout(() => {
            const preloader = document.getElementById('preloader');
            preloader.style.opacity = '0';
            preloader.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
              preloader.style.display = 'none';
              
              // Clean up UI elements after loading
              this.cleanupUI();
            }, 500);
          }, 500);
        } catch (error) {
          console.error('Failed to load game:', error);
          document.getElementById('loading-text').textContent = 'Failed to load game. Please refresh the page.';
        }
      }
      
      async loadGameScript() {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'mars.js';
          script.onload = () => {
            console.log('Game script loaded successfully');
            resolve();
          };
          script.onerror = (error) => {
            console.error('Failed to load game script:', error);
            this.showErrorMessage('Failed to load game. Please refresh the page.');
            reject(error);
          };
          document.head.appendChild(script);
        });
      }
      
      showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 8px;
          z-index: 10001;
          text-align: center;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        errorDiv.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 10px;">Error</div>
          <div style="margin-bottom: 15px;">${message}</div>
          <button onclick="location.reload()" style="
            background: white;
            color: red;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
          ">Refresh Page</button>
        `;
        
        document.body.appendChild(errorDiv);
      }
      
      // Add WebGL compatibility check
      checkWebGLSupport() {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
          this.showErrorMessage('WebGL is not supported on this device. Please use a modern browser with WebGL support.');
          return false;
        }
        
        return true;
      }
      
      // Auto-load ambient music after game loads
      loadAmbientMusic() {
        setTimeout(() => {
          console.log('Loading Mars ambient music...');
          
          // Load YouTube audio with autoplay
          const videoId = 'QGe0wLjJDqA'; // Mars Ambience Sound
          youtubePlayer.loadVideo(videoId, {
            autoplay: true,
            loop: true,
            volume: 25
          });
          
          // Show audio container
          document.getElementById('youtube-audio-container').style.display = 'block';
          
          // Show click-to-play notification since autoplay might be blocked
          this.showClickToPlayNotification();
          
        }, 1000); // Wait 1 second after game loads
      }
      
      // Show click-to-play notification
      showClickToPlayNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          bottom: 80px;
          right: 20px;
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 12px 20px;
          border-radius: 25px;
          z-index: 10001;
          font-size: 12px;
          text-align: center;
          border: 2px solid rgba(255, 107, 53, 0.6);
          backdrop-filter: blur(15px);
          transition: all 0.3s ease;
          cursor: pointer;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          max-width: 200px;
        `;
        
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; flex-direction: column;">
            <span style="font-size: 16px; animation: pulse 2s infinite;">🎵</span>
            <div style="font-size: 11px; text-align: center;">
              <div style="font-weight: bold; margin-bottom: 2px;">Mars Music</div>
              <div style="opacity: 0.8;">Tap to play</div>
            </div>
          </div>
        `;
        
        // Add pulsing animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
          }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(notification);
        
        // Enable audio on click
        const enableAudio = () => {
          console.log('User clicked to enable audio');
          
          // Try to start YouTube audio using force play
          if (youtubePlayer && typeof youtubePlayer.forcePlay === 'function') {
            youtubePlayer.forcePlay();
          } else if (youtubePlayer && typeof youtubePlayer.togglePlayback === 'function') {
            youtubePlayer.togglePlayback();
          }
          
          // Update notification
          notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 20px;">🎶</span>
              <div style="font-weight: bold; color: #4CAF50;">Mars Music Playing!</div>
            </div>
          `;
          notification.style.background = 'rgba(76, 175, 80, 0.9)';
          notification.style.borderColor = 'rgba(76, 175, 80, 0.6)';
          notification.style.cursor = 'default';
          
          // Remove after success
          setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(20px)';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }, 1500);
          
          // Remove click listener
          notification.removeEventListener('click', enableAudio);
        };
        
        // Add click listener
        notification.addEventListener('click', enableAudio);
        
        // Auto-remove after 5 seconds if not clicked
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(20px)';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }
        }, 5000);
      }
      
      // Clean up UI elements after loading
      cleanupUI() {
        // Hide the YouTube load button since audio auto-loads
        const loadButton = document.getElementById('load-youtube');
        if (loadButton) {
          loadButton.style.display = 'none';
        }
        
        // Hide bottom mode buttons (keep code intact, just hide UI)
        this.hideBottomModeButtons();
        
        // Platform-specific cleanup
        if (this.deviceSpecs.isMobile) {
          // Mobile cleanup
          const settingsToggle = document.getElementById('settings-toggle');
          if (settingsToggle) {
            settingsToggle.style.display = 'none';
          }
          
          // Show mobile instructions after a delay
          setTimeout(() => {
            this.showMobileInstructions();
          }, 3000);
        } else {
          // Desktop cleanup
          const mobileControls = document.getElementById('mobile-controls');
          if (mobileControls) {
            mobileControls.remove();
          }
          
          // Keep settings available on desktop
          const settingsToggle = document.getElementById('settings-toggle');
          if (settingsToggle) {
            settingsToggle.style.display = 'block';
          }
        }
        
        // Auto-hide performance settings
        const performanceSettings = document.getElementById('performance-settings');
        if (performanceSettings) {
          performanceSettings.style.display = 'none';
        }
        
        // Remove device info permanently
        const deviceInfo = document.getElementById('device-info');
        if (deviceInfo) {
          deviceInfo.remove();
        }
        
        console.log('UI cleaned up for better gaming experience');
      }
      
      // Hide the bottom mode buttons (day/night, stylized mode)
      hideBottomModeButtons() {
        // Use a setTimeout to ensure the buttons are created first
        setTimeout(() => {
          // Find and hide buttons positioned at the bottom of the screen
          const buttons = document.querySelectorAll('button');
          buttons.forEach(button => {
            const computedStyle = window.getComputedStyle(button);
            const position = computedStyle.position;
            const bottom = computedStyle.bottom;
            const right = computedStyle.right;
            
            // Check if button is positioned at bottom of screen
            if (position === 'absolute' && 
                (bottom === '20px' || bottom === '60px') && 
                (right === '20px' || right === '180px')) {
              
              // Check button text to identify the mode buttons
              const buttonText = button.textContent.toLowerCase();
              if (buttonText.includes('day') || 
                  buttonText.includes('night') || 
                  buttonText.includes('stylized') || 
                  buttonText.includes('realistic') || 
                  buttonText.includes('force')) {
                
                // Hide the button but keep it functional
                button.style.display = 'none';
                console.log('Hidden mode button:', button.textContent);
              }
            }
          });
          
          console.log('Bottom mode buttons hidden');
        }, 2000); // Wait 2 seconds for buttons to be created
        
        // Set up a periodic check to catch any buttons created later
        const checkInterval = setInterval(() => {
          const buttons = document.querySelectorAll('button');
          let foundNewButtons = false;
          
          buttons.forEach(button => {
            const computedStyle = window.getComputedStyle(button);
            const position = computedStyle.position;
            const bottom = computedStyle.bottom;
            const right = computedStyle.right;
            
            if (position === 'absolute' && 
                (bottom === '20px' || bottom === '60px') && 
                (right === '20px' || right === '180px') &&
                button.style.display !== 'none') {
              
              const buttonText = button.textContent.toLowerCase();
              if (buttonText.includes('day') || 
                  buttonText.includes('night') || 
                  buttonText.includes('stylized') || 
                  buttonText.includes('realistic') || 
                  buttonText.includes('force')) {
                
                button.style.display = 'none';
                foundNewButtons = true;
                console.log('Hidden newly created mode button:', button.textContent);
              }
            }
          });
          
          // Stop checking after 30 seconds
          if (Date.now() - this.cleanupStartTime > 30000) {
            clearInterval(checkInterval);
          }
        }, 1000);
        
        // Record start time for cleanup
        this.cleanupStartTime = Date.now();
      }
      
      // Show mobile instructions
      showMobileInstructions() {
        const instructions = document.createElement('div');
        instructions.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 15px;
          z-index: 10002;
          text-align: center;
          max-width: 320px;
          font-size: 14px;
          border: 2px solid rgba(255, 107, 53, 0.5);
          backdrop-filter: blur(15px);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        `;
        instructions.innerHTML = `
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #ff6b35;">🎮 Mobile Controls</div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">🕹️</span>
            <span style="font-size: 13px;">Use left joystick to move rover</span>
          </div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">👆</span>
            <span style="font-size: 13px;">Swipe anywhere to look around</span>
          </div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">💎</span>
            <span style="font-size: 13px;">Tap SAMPLE to collect glowing objects</span>
          </div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">🔬</span>
            <span style="font-size: 13px;">Tap ANALYZE to study collected samples</span>
          </div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">🚀</span>
                                <span style="font-size: 13px;">SpaceX starships on display</span>
          </div>
          <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">📷</span>
            <span style="font-size: 13px;">Tap CAMERA to switch views</span>
          </div>
          <div style="margin-bottom: 20px; font-size: 11px; opacity: 0.7; text-align: center;">
            🎧 Music auto-loads | 🌟 Look for glowing samples to collect!
          </div>
          <button onclick="this.parentNode.remove()" style="
            background: linear-gradient(145deg, #ff6b35, #e55a2b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
          ">Start Exploring Mars! 🚀</button>
        `;
        
        document.body.appendChild(instructions);
        
        // Auto-remove after 6 seconds for faster dismissal
        setTimeout(() => {
          if (instructions.parentNode) {
            instructions.style.opacity = '0';
            instructions.style.transform = 'translate(-50%, -50%) scale(0.9)';
            setTimeout(() => {
              instructions.remove();
            }, 300);
          }
        }, 6000);
      }
    }
    
          // Mobile Controls Class
      class MobileControls {
        constructor() {
          this.joystick = {
            element: null,
            knob: null,
            active: false,
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            maxDistance: 40
          };
          
          this.camera = {
            element: null,
            startX: 0,
            startY: 0,
            sensitivity: 0.003
          };
          
          this.virtualKeys = {
            w: false,
            a: false,
            s: false,
            d: false
          };
          
          this.isMobile = isMobileDevice();
          
          if (this.isMobile) {
            this.initializeMobileControls();
          }
        }
        
        initializeMobileControls() {
          const mobileControls = document.getElementById('mobile-controls');
          if (!mobileControls) return;
          
          mobileControls.classList.add('show');
          
          // Prevent page scrolling on mobile
          document.body.style.overflow = 'hidden';
          document.body.style.position = 'fixed';
          document.body.style.width = '100%';
          document.body.style.height = '100%';
          
          // Prevent pull-to-refresh on mobile
          document.addEventListener('touchmove', (e) => {
            e.preventDefault();
          }, { passive: false });
          
          this.initializeJoystick();
          this.initializeTouchCamera();
          this.initializeMobileButtons();
        }
        
        initializeJoystick() {
          this.joystick.element = document.getElementById('virtual-joystick');
          this.joystick.knob = document.getElementById('joystick-knob');
          
          if (!this.joystick.element || !this.joystick.knob) return;
          
                     // Touch start
           this.joystick.element.addEventListener('touchstart', (e) => {
             e.preventDefault();
             const touch = e.touches[0];
             const rect = this.joystick.element.getBoundingClientRect();
             
             this.joystick.active = true;
             this.joystick.startX = rect.left + rect.width / 2;
             this.joystick.startY = rect.top + rect.height / 2;
             
             // Add haptic feedback if available
             if (navigator.vibrate) {
               navigator.vibrate(50);
             }
             
             // Visual feedback
             this.joystick.element.style.background = 'rgba(255, 107, 53, 0.3)';
             
             this.updateJoystick(touch.clientX, touch.clientY);
           });
          
          // Touch move
          this.joystick.element.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!this.joystick.active) return;
            
            const touch = e.touches[0];
            this.updateJoystick(touch.clientX, touch.clientY);
          });
          
                     // Touch end
           const endTouch = () => {
             this.joystick.active = false;
             this.joystick.knob.style.transform = 'translate(-50%, -50%)';
             
             // Reset visual feedback
             this.joystick.element.style.background = 'rgba(255, 255, 255, 0.1)';
             
             this.resetVirtualKeys();
           };
          
          this.joystick.element.addEventListener('touchend', endTouch);
          this.joystick.element.addEventListener('touchcancel', endTouch);
        }
        
        updateJoystick(clientX, clientY) {
          const deltaX = clientX - this.joystick.startX;
          const deltaY = clientY - this.joystick.startY;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          
          if (distance <= this.joystick.maxDistance) {
            this.joystick.currentX = deltaX;
            this.joystick.currentY = deltaY;
          } else {
            const angle = Math.atan2(deltaY, deltaX);
            this.joystick.currentX = Math.cos(angle) * this.joystick.maxDistance;
            this.joystick.currentY = Math.sin(angle) * this.joystick.maxDistance;
          }
          
          // Update knob position
          this.joystick.knob.style.transform = 
            `translate(${-50 + this.joystick.currentX}%, ${-50 + this.joystick.currentY}%)`;
          
          // Update virtual keys based on joystick position
          this.updateVirtualKeys();
        }
        
        updateVirtualKeys() {
          const threshold = 15;
          
          this.virtualKeys.w = this.joystick.currentY < -threshold;
          this.virtualKeys.s = this.joystick.currentY > threshold;
          this.virtualKeys.a = this.joystick.currentX < -threshold;
          this.virtualKeys.d = this.joystick.currentX > threshold;
          
          // Update the global keys object if it exists
          if (typeof window.keys !== 'undefined') {
            Object.assign(window.keys, this.virtualKeys);
          }
          
          // Dispatch key events for compatibility
          this.dispatchKeyEvents();
        }
        
        dispatchKeyEvents() {
          Object.keys(this.virtualKeys).forEach(key => {
            if (this.virtualKeys[key] !== this.lastKeys?.[key]) {
              const event = new KeyboardEvent(
                this.virtualKeys[key] ? 'keydown' : 'keyup',
                { key: key, bubbles: true }
              );
              document.dispatchEvent(event);
            }
          });
          
          this.lastKeys = { ...this.virtualKeys };
        }
        
        resetVirtualKeys() {
          Object.keys(this.virtualKeys).forEach(key => {
            this.virtualKeys[key] = false;
          });
          
          if (typeof window.keys !== 'undefined') {
            Object.assign(window.keys, this.virtualKeys);
          }
          
          this.dispatchKeyEvents();
        }
        
        initializeTouchCamera() {
          this.camera.element = document.getElementById('touch-camera-area');
          if (!this.camera.element) return;
          
          let lastTouchX = 0;
          let lastTouchY = 0;
          
          this.camera.element.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
              lastTouchX = e.touches[0].clientX;
              lastTouchY = e.touches[0].clientY;
            }
          });
          
          this.camera.element.addEventListener('touchmove', (e) => {
            e.preventDefault();
            
            if (e.touches.length === 1) {
              const touch = e.touches[0];
              const deltaX = touch.clientX - lastTouchX;
              const deltaY = touch.clientY - lastTouchY;
              
              // Simulate mouse movement for camera controls
              if (window.cameraMode === 'orbit' && window.controls) {
                // For orbit controls
                window.controls.object.rotation.y -= deltaX * this.camera.sensitivity;
                window.controls.object.rotation.x -= deltaY * this.camera.sensitivity;
              } else {
                // For other camera modes, update rover rotation
                if (typeof window.roverYaw !== 'undefined') {
                  window.roverYaw -= deltaX * this.camera.sensitivity;
                }
              }
              
              lastTouchX = touch.clientX;
              lastTouchY = touch.clientY;
            }
          });
        }
        
        initializeMobileButtons() {
          const sampleBtn = document.getElementById('mobile-sample-btn');
          const analyzeBtn = document.getElementById('mobile-analyze-btn');
          const rocketBtn = document.getElementById('mobile-rocket-btn');
          const cameraBtn = document.getElementById('mobile-camera-btn');
          
          // Enhanced button handler with debouncing
          const createButtonHandler = (button, action, cooldown = 500) => {
            let lastPress = 0;
            let isPressed = false;
            
            const handlePress = (e) => {
              e.preventDefault();
              e.stopPropagation();
              
              const now = Date.now();
              if (now - lastPress < cooldown || isPressed) {
                return;
              }
              
              isPressed = true;
              lastPress = now;
              
              // Visual feedback
              button.style.transform = 'scale(0.85)';
              button.style.background = 'rgba(255, 107, 53, 0.9)';
              button.style.borderColor = 'rgba(255, 107, 53, 1)';
              
              // Haptic feedback
              if (navigator.vibrate) {
                navigator.vibrate(80);
              }
              
              // Execute action
              setTimeout(() => {
                action();
                
                // Reset visual feedback
                setTimeout(() => {
                  button.style.transform = 'scale(1)';
                  button.style.background = 'rgba(0, 0, 0, 0.6)';
                  button.style.borderColor = 'rgba(255, 107, 53, 0.5)';
                  isPressed = false;
                }, 100);
              }, 50);
            };
            
            // Use touchend for better control
            button.addEventListener('touchend', handlePress);
            
            // Prevent context menu and other touch interference
            button.addEventListener('touchstart', (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
            
            button.addEventListener('touchmove', (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
            
            button.addEventListener('touchcancel', (e) => {
              e.preventDefault();
              button.style.transform = 'scale(1)';
              button.style.background = 'rgba(0, 0, 0, 0.6)';
              button.style.borderColor = 'rgba(255, 107, 53, 0.5)';
              isPressed = false;
            });
          };
          
          // Sample Collection Button (E key equivalent)
          if (sampleBtn) {
            createButtonHandler(sampleBtn, () => {
              if (window.keys && window.sampleSystem && window.rover) {
                const collected = window.sampleSystem.collectSample(window.rover.position);
                if (collected) {
                  this.showMobileNotification('💎 Sample Collected!', '#00ff88');
                } else {
                  this.showMobileNotification('No samples nearby', '#ffaa44');
                }
              }
            }, 600);
          }
          
          // Sample Analysis Button (Q key equivalent)
          if (analyzeBtn) {
            createButtonHandler(analyzeBtn, () => {
              if (window.sampleSystem) {
                const samples = window.sampleSystem.getCollectedSamples();
                if (samples.length > 0) {
                  const lastSample = samples[samples.length - 1];
                  const analysis = window.sampleSystem.analyzeSample(lastSample.id);
                  if (analysis && window.showAnalysisDialog) {
                    window.showAnalysisDialog(analysis);
                    this.showMobileNotification('🔬 Analysis Ready!', '#00ff88');
                  }
                } else {
                  this.showMobileNotification('No samples to analyze', '#ffaa44');
                }
              }
            }, 800);
          }
          
          // Rocket Launch Button (R key equivalent)
          if (rocketBtn) {
            createButtonHandler(rocketBtn, () => {
              if (window.marsSceneManager && window.marsSceneManager.rocketLaunchActive) {
                if (!window.lastManualRocketLaunch || Date.now() - window.lastManualRocketLaunch > 3000) {
                  window.lastManualRocketLaunch = Date.now();
                  window.marsSceneManager.triggerManualLaunch();
                  // Rocket launch notification removed - starships stay on ground
                } else {
                  this.showMobileNotification('Rocket cooldown...', '#ffaa44');
                }
              } else {
                this.showMobileNotification('Rockets optimized for mobile - enhanced visibility!', '#00ff88');
              }
            }, 1000);
          }
          
          // Camera Toggle Button (C key equivalent)
          if (cameraBtn) {
            createButtonHandler(cameraBtn, () => {
              if (typeof window.toggleCameraMode === 'function') {
                window.toggleCameraMode();
                this.showCameraModeIndicator();
              }
            }, 400);
          }
        }
         
         showCameraModeIndicator() {
           const cameraMode = window.cameraMode || 'thirdPerson';
           const modeNames = {
             'orbit': '🌍 Orbit View',
             'thirdPerson': '🚗 Third Person',
             'firstPerson': '👁️ First Person'
           };
           
           this.showMobileNotification(modeNames[cameraMode] || '📷 Camera Mode', '#00ff88');
         }
         
         showMobileNotification(message, color = '#00ff88') {
           const notification = document.createElement('div');
           notification.style.cssText = `
             position: fixed;
             top: 20px;
             left: 50%;
             transform: translateX(-50%);
             background: rgba(0, 0, 0, 0.9);
             color: white;
             padding: 12px 24px;
             border-radius: 25px;
             z-index: 10003;
             font-size: 16px;
             font-weight: bold;
             transition: all 0.3s ease;
             border: 2px solid ${color};
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
             backdrop-filter: blur(10px);
           `;
           
           notification.textContent = message;
           document.body.appendChild(notification);
           
           // Fade out and remove
           setTimeout(() => {
             notification.style.opacity = '0';
             notification.style.transform = 'translateX(-50%) translateY(-20px)';
             setTimeout(() => {
               if (notification.parentNode) {
                 notification.parentNode.removeChild(notification);
               }
             }, 300);
           }, 2000);
         }
        

      }
      
      // Initialize optimizer when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        new GameOptimizer();
        new MobileControls();
      });
  </script>
  
  <script>
    // Simple YouTube audio player implementation
    const youtubePlayer = {
      player: null,
      videoId: null,
      isPlaying: false,
      
      loadVideo: function(videoId, options = {}) {
        this.videoId = videoId;
        
        // Show the container
        document.getElementById('youtube-audio-container').style.display = 'block';
        
        // Create wrapper for the player if it doesn't exist
        const wrapper = document.getElementById('youtube-player-wrapper');
        
        // Clear any existing player
        wrapper.innerHTML = '';
        
        // Create iframe placeholder for the YouTube API to replace
        const playerDiv = document.createElement('div');
        playerDiv.id = 'youtube-iframe';
        playerDiv.style.width = '1px';
        playerDiv.style.height = '1px';
        playerDiv.style.opacity = '0.01';
        playerDiv.style.pointerEvents = 'none';
        
        // Add placeholder to the DOM
        wrapper.appendChild(playerDiv);
        
        // Load YouTube API if not already loaded
        if (typeof YT === 'undefined' || !YT.loaded) {
          // Save reference to this object for the callback
          window.youtubePlayerRef = this;
          window.youtubePlayerOptions = options;
          
          const tag = document.createElement('script');
          tag.src = 'https://www.youtube.com/iframe_api';
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          
          // Define the callback function that YouTube API will call when ready
          window.onYouTubeIframeAPIReady = function() {
            window.youtubePlayerRef._initPlayer(window.youtubePlayerOptions);
          };
        } else {
          // YouTube API already loaded, initialize player directly
          this._initPlayer(options);
        }
        
        // Set up event listeners
        document.getElementById('youtube-play-pause').addEventListener('click', () => {
          this.togglePlayback();
        });
        
        document.getElementById('youtube-volume').addEventListener('input', (e) => {
          if (this.player && typeof this.player.setVolume === 'function') {
            this.player.setVolume(parseInt(e.target.value));
          }
        });
      },
      
      _initPlayer: function(options) {
        try {
          console.log('Initializing YouTube player with video ID:', this.videoId);
          
          // Set iframe permissions before creating player
          const iframeElement = document.getElementById('youtube-iframe');
          if (iframeElement) {
            iframeElement.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
          }
          
          this.player = new YT.Player('youtube-iframe', {
            height: '1',
            width: '1',
            videoId: this.videoId,
            playerVars: {
              autoplay: options.autoplay ? 1 : 0,
              loop: options.loop ? 1 : 0,
              playlist: options.loop ? this.videoId : '',
              controls: 0,
              showinfo: 0,
              modestbranding: 1,
              iv_load_policy: 3,
              rel: 0
            },
            events: {
              'onReady': (event) => {
                console.log('YouTube player ready');
                // Set initial volume
                const volumeSlider = document.getElementById('youtube-volume');
                if (volumeSlider && typeof event.target.setVolume === 'function') {
                  event.target.setVolume(parseInt(volumeSlider.value));
                }
                
                // Try to auto-play if specified
                if (options.autoplay && typeof event.target.playVideo === 'function') {
                  console.log('Attempting to autoplay...');
                  
                  // Try to play immediately
                  setTimeout(() => {
                    try {
                      event.target.playVideo();
                      this.isPlaying = true;
                      document.getElementById('youtube-play-pause').textContent = 'Pause';
                      console.log('Autoplay successful');
                    } catch (error) {
                      console.log('Autoplay blocked by browser policy:', error);
                    }
                  }, 100);
                  
                  // Also try after a short delay
                  setTimeout(() => {
                    if (!this.isPlaying) {
                      try {
                        event.target.playVideo();
                        this.isPlaying = true;
                        document.getElementById('youtube-play-pause').textContent = 'Pause';
                        console.log('Delayed autoplay successful');
                      } catch (error) {
                        console.log('Delayed autoplay also blocked');
                      }
                    }
                  }, 1000);
                }
                
                // Get video title
                if (typeof event.target.getVideoData === 'function') {
                  const videoData = event.target.getVideoData();
                  const titleElement = document.getElementById('youtube-title');
                  if (titleElement && videoData && videoData.title) {
                    titleElement.textContent = videoData.title;
                  }
                }
              },
              'onStateChange': (event) => {
                console.log('YouTube player state changed:', event.data);
                // Update play/pause button based on player state
                if (event.data === YT.PlayerState.PLAYING) {
                  this.isPlaying = true;
                  document.getElementById('youtube-play-pause').textContent = 'Pause';
                  console.log('YouTube audio is now playing');
                  
                  // Hide any click-to-play notifications when audio starts
                  this.hideClickToPlayNotifications();
                } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                  this.isPlaying = false;
                  document.getElementById('youtube-play-pause').textContent = 'Play';
                  console.log('YouTube audio paused/ended');
                }
              },
              'onError': (event) => {
                console.error('YouTube player error:', event.data);
              }
            }
          });
          
          console.log('YouTube player object created:', this.player);
        } catch (error) {
          console.error('Error initializing YouTube player:', error);
        }
      },
      
      togglePlayback: function() {
        if (!this.player) {
          console.error('YouTube player not initialized');
          return;
        }
        
        try {
          if (this.isPlaying) {
            if (typeof this.player.pauseVideo === 'function') {
              this.player.pauseVideo();
              this.isPlaying = false;
              document.getElementById('youtube-play-pause').textContent = 'Play';
              console.log('YouTube playback paused');
            } else {
              console.error('pauseVideo method not available on player object');
            }
          } else {
            if (typeof this.player.playVideo === 'function') {
              console.log('Starting YouTube playback...');
              this.player.playVideo();
              this.isPlaying = true;
              document.getElementById('youtube-play-pause').textContent = 'Pause';
              console.log('YouTube playback started');
            } else {
              console.error('playVideo method not available on player object');
            }
          }
        } catch (error) {
          console.error('Error toggling YouTube playback:', error);
        }
      },
      
      // Force start playback (for user-initiated actions)
      forcePlay: function() {
        if (!this.player) {
          console.error('YouTube player not initialized for force play');
          return;
        }
        
        try {
          if (typeof this.player.playVideo === 'function') {
            console.log('Force starting YouTube playback...');
            this.player.playVideo();
            this.isPlaying = true;
            document.getElementById('youtube-play-pause').textContent = 'Pause';
            console.log('YouTube playback force started');
          } else {
            console.error('playVideo method not available for force play');
          }
        } catch (error) {
          console.error('Error force starting YouTube playback:', error);
        }
      },
      
      // Hide click-to-play notifications when audio starts
      hideClickToPlayNotifications: function() {
        const notifications = document.querySelectorAll('div');
        notifications.forEach(notification => {
          if (notification.innerHTML && notification.innerHTML.includes('Click to Enable Mars Music')) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(-50%) translateY(-20px)';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }
        });
      }
    };
    
    // YouTube button is now hidden as audio auto-loads
    // Event listener removed to clean up the interface
    
    // Add click listener to YouTube controls for easier access
    setTimeout(() => {
      const playPauseButton = document.getElementById('youtube-play-pause');
      if (playPauseButton) {
        playPauseButton.addEventListener('click', () => {
          if (youtubePlayer && youtubePlayer.player) {
            youtubePlayer.togglePlayback();
          }
        });
      }
    }, 3000);
  </script>
</body>
</html>
